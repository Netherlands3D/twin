<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes">
    <title>NL3D | {{{ PRODUCT_VERSION }}}</title>
    <!-- Visual style CSS -->
    <link rel="stylesheet" href="TemplateData/style.css" />
    <script src="js/mobile-detect.min.js"></script>
</head>
<body>
    <!-- Parallax Layers -->
    <div id="parallaxContainer">
        <div class="parallax-layer" id="layer-back"></div>
        <div class="parallax-layer" id="layer-mid"></div>
        <div class="parallax-layer" id="layer-front"></div>
    </div>

    <!-- Debug Panel -->
    <div id="nl3d-debug" class="debug-panel"></div>

    <!-- Mobile Warning Dialog -->
    <div id="unity-mobile-warning" class="dialog" style="z-index:20;"></div>

    <!-- Load Error Dialog -->
    <div id="unity-load-error" class="dialog" style="z-index:20;"></div>

    <!-- Loading Overlay with Flipbook -->
    <div id="loadingOverlay">
        <div id="overlayContent">
            <div id="flipbookLogo"></div>
            <div id="progressContainer"><div id="progressBar"></div></div>
            <p id="progressPercent">0%</p>
        </div>
    </div>

    <!-- Unity Canvas Container -->
    <div id="unityContainer"></div>

    <!-- Parallax Script -->
    <script>
        (function () {
            const layers = {
                back: document.getElementById('layer-back'),
                mid: document.getElementById('layer-mid'),
                front: document.getElementById('layer-front')
            };
            const maxTranslate = { back: 0, mid: 20, front: 40 };
            window.addEventListener('mousemove', e => {
                const w = window.innerWidth, h = window.innerHeight;
                const nx = (e.clientX / w) - 0.5, ny = (e.clientY / h) - 0.5;
                layers.back.style.transform = 'translate(0px, 0px)';
                layers.mid.style.transform = `translate(${-nx * maxTranslate.mid}px, ${-ny * maxTranslate.mid}px)`;
                layers.front.style.transform = `translate(${-nx * maxTranslate.front}px, ${-ny * maxTranslate.front}px)`;
            });
        })();
    </script>

    <!-- Functional Loading & Mobile Logic -->
    <script>
      const md = new MobileDetect(window.navigator.userAgent);
      const isMobileDevice = md.mobile() !== null;
      let unityInstance;

      function ShowDebugPanel() {
          const params = new URLSearchParams(window.location.search);
          if (params.has('debug')) {
              const dbg = document.getElementById('nl3d-debug');
              dbg.style.display = 'flex';
              dbg.innerHTML = `<p>{{{ PRODUCT_NAME }}} v{{{ PRODUCT_VERSION }}} · Mobile: ${isMobileDevice?'Yes':'No'} · User Agent: ${navigator.userAgent}</p>`;
          }
      }

      function LoadUnity() {
          const buildUrl = 'Build';
          const loaderUrl = `${buildUrl}/{{{ LOADER_FILENAME }}}`;
          const config = {
              dataUrl:    `${buildUrl}/{{{ DATA_FILENAME }}}`,
              frameworkUrl:`${buildUrl}/{{{ FRAMEWORK_FILENAME }}}`,
              codeUrl:    `${buildUrl}/{{{ CODE_FILENAME }}}`,
              streamingAssetsUrl: 'StreamingAssets',
              companyName:   '{{{ COMPANY_NAME }}}',
              productName:   '{{{ PRODUCT_NAME }}}',
              productVersion:'{{{ PRODUCT_VERSION }}}'
          };
          if (isMobileDevice) config.devicePixelRatio = 2;

          // Ensure overlay is visible
          document.getElementById('unity-mobile-warning').classList.remove('--visible');
          const overlay = document.getElementById('loadingOverlay');
          overlay.style.display = 'flex';

          // Create and append canvas for Unity
          const container = document.getElementById('unityContainer');
          container.innerHTML = '';
          const canvas = document.createElement('canvas');
          canvas.id = 'unity-canvas';
          canvas.className = 'unity-canvas noselect';
          container.appendChild(canvas);

          // Load Unity loader script
          const script = document.createElement('script');
          script.src = loaderUrl;
          script.onerror = () => { document.getElementById('unity-load-error').classList.add('--visible'); };
          script.onload = () => {
              createUnityInstance(
                  canvas,
                  config,
                  progress => {
                      const pct = Math.round(progress * 100);
                      document.getElementById('progressBar').style.width = `${pct}%`;
                      document.getElementById('progressPercent').textContent = `${pct}%`;
                      if (pct === 100) setTimeout(() => overlay.style.display = 'none', 500);
                  }
              ).then(instance => { unityInstance = instance; })
               .catch(err => alert(err));
          };
          document.body.appendChild(script);
      }

      ShowDebugPanel();
      if (isMobileDevice) {
          document.getElementById('unity-mobile-warning').classList.add('--visible');
      } else {
          LoadUnity();
      }
    </script>
</body>
</html>
